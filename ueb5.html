<!DOCTYPE html>
<html>

<head>
    <title>Uebung 5</title>
    <meta charset="UTF-8">
    <meta http-equiv="content-script-type" content="text/javascript" />
    <meta http-equiv="content-style-type" content="text/css" />
    <meta http-equiv="content-language" content="en" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
        crossorigin="" />
    <link rel="stylesheet" type="text/css" href="Leaflet.markercluster-1.0.4/dist/MarkerCluster.css"></link>
    <link rel="stylesheet" type="text/css" href="Leaflet.markercluster-1.0.4/dist/MarkerCluster.Default.css"></link>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
        crossorigin=""></script>
    <script type="text/javascript" src="js/osmtogeojson.js"></script>
    <script src="js/leaflet.ajax.min.js"></script>
    <style>
        #map {
            height: 850px;
            width: 850px;
        }
    </style>
</head>

<body>
    <h1>OSM Abfrage mit Overpass API</h1>
    <div id="map">

        <div class="leaflet-control-container">
            <div class="leaflet-top leaflet-right">
                <div id="overpass-api-controls" class="leaflet-bar leaflet-control">
                    <input id="query-textfield" value="leisure=playground" size="50">
                    <input id="query-button" type="button" value="Laden">
                </div>
            </div>
        </div>

    </div>
    <script>
        var map = L.map('map').setView([47.25386, 8.69301], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.se/hydda/full/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Tiles courtesy of <a href="http://openstreetmap.se/" target="_blank">OpenStreetMap Sweden</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        function buildOverpassApiUrl(map, overpassQuery) {
            var bounds = map.getBounds().getSouth() + ',' + map.getBounds().getWest() + ',' + map.getBounds().getNorth() +
                ',' + map.getBounds().getEast();
            var nodeQuery = 'node[' + overpassQuery + '](' + bounds + ');';
            var wayQuery = 'way[' + overpassQuery + '](' + bounds + ');';
            var relationQuery = 'relation[' + overpassQuery + '](' + bounds + ');';
            var query = '?data=[out:xml][timeout:25];(' + nodeQuery + wayQuery + relationQuery +
                ');out body;>;out skel qt;';
            var baseUrl = 'http://overpass-api.de/api/interpreter';
            var resultUrl = baseUrl + query;
            return resultUrl;
        }

        $("#query-button").click(function () {
            var queryTextfieldValue = $("#query-textfield").val();
            var overpassApiUrl = buildOverpassApiUrl(map, queryTextfieldValue);

            $.get(overpassApiUrl, function (osmDataAsXml) {
                var resultAsGeojson = osmtogeojson(osmDataAsXml);
                var resultLayer = L.geoJson(resultAsGeojson, {
                    style: function (feature) {
                        return {
                            color: "#ff0000"
                        };
                    }
                }).addTo(map);
            });
        });
    </script>
</body>

</html>